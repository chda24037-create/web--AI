<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>„Åç„ÅÆ„Åì„Åü„Åë„ÅÆ„Åì AI„Ç≥„É≠„Ç∑„Ç¢„É† - FINAL PRODUCTION</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React„ÅÆÊäïÁ•®„Ç∑„Çπ„ÉÜ„É†„Å´ÂøÖË¶Å -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script src="https://unpkg.com/lucide@latest"></script>

    <link href="https://fonts.googleapis.com/css2?family=DotGothic16&display=swap" rel="stylesheet">
    <style>
        :root {
            --take-green: #00a000;
            --take-bg: #e0ffe0;
            --kino-brown: #a05000;
            --kino-bg: #ffe0cc;
            --hp-high: #00ff00;
            --hp-mid: #ffff00;
            --hp-low: #ff0000;
            --retro-black: #1a1a1a;
            --retro-white: #f0f0f0;
            --shadow-color: #000;
        }

        body {
            font-family: "DotGothic16", sans-serif;
            background-color: #2b2b2b;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            color: var(--retro-white);
            image-rendering: pixelated;
        }

  
        * { border-radius: 0 !important; }

   
        body::after {
            content: " "; display: block; position: absolute; top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            z-index: 999; background-size: 100% 2px, 3px 100%; pointer-events: none;
        }


        @keyframes shake-hard {
            0% { transform: translate(0, 0); } 20% { transform: translate(-4px, 4px); } 40% { transform: translate(4px, -4px); } 60% { transform: translate(-4px, -4px); } 80% { transform: translate(4px, 4px); } 100% { transform: translate(0, 0); }
        }
        .shake-small { animation: shake-hard 0.2s steps(2) both; }
        .shake-hard { animation: shake-hard 0.4s steps(4) both; }

        @keyframes flash-red {
            0%, 100% { background-color: transparent; } 50% { background-color: var(--hp-low); }
        }
        .flash-damage {
            position: absolute; inset: 0; pointer-events: none; z-index: 40;
            animation: flash-red 0.1s steps(2) 2; opacity: 0.5;
        }

        /* „Ç≥„Ç§„É≥„Éà„Çπ„ÄÄ„Éê„Ç∞„ÅÇ„ÇãÔºÅÔºÅ */
        .coin-container { perspective: none; }
        .coin {
            width: 120px; height: 120px; position: relative; border: 4px solid #fff; background: #eab308; box-shadow: 4px 4px 0 #000;
        }
        .coin.flipping { animation: flip-8bit 0.2s infinite steps(2); }
        @keyframes flip-8bit {
            0% { transform: scaleX(1); background: #eab308; } 50% { transform: scaleX(0.1); background: #fff; } 100% { transform: scaleX(1); background: #eab308; }
        }
        .coin-face {
            position: absolute; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.5rem; color: #000;
        }
        
   
        .cut-in-container {
            position: fixed; inset: 0; pointer-events: none; z-index: 100;
            display: flex; align-items: center; justify-content: center; opacity: 0; transition: none;
        }
        .cut-in-container.active { opacity: 1; }
        .cut-in-text {
            font-family: "DotGothic16", sans-serif; font-size: 5rem; color: #fff; text-shadow: 4px 4px 0 #ff0000, 8px 8px 0 #000; transform: scale(1);
        }
        .perfect-text {
            font-family: "DotGothic16", sans-serif; font-size: 6rem; color: #ffff00; text-shadow: 4px 4px 0 #ff0000, 8px 8px 0 #000; transform: scale(1); display: none;
        }
        .cut-in-container.perfect-active .perfect-text { display: block; }


        .speed-lines {
            position: absolute; inset: 0; background-image: radial-gradient(#fff 10%, transparent 10%); background-size: 10px 10px; opacity: 0.1; z-index: -1;
        }

        /*Êà¶Èóò„ÅÆUI*/
        .theme-takenoko .header-bg { background: var(--take-green); border-bottom: 4px solid #fff; }
        .theme-kinoko .header-bg { background: var(--kino-brown); border-bottom: 4px solid #fff; }
        
        .chat-bubble {
            max-width: 95%; padding: 12px; border: 2px solid #fff; position: relative; margin-bottom: 16px; font-size: 1rem; line-height: 1.5; box-shadow: 4px 4px 0 #000; background: #000; color: #fff; word-wrap: break-word;
        }
        .chat-bubble.self { border-color: #00ff00; color: #00ff00; margin-left: auto; }
        .chat-bubble.opponent { border-color: #ff0000; color: #ff0000; margin-right: auto; }
        
        /* HP„Éê„Éº*/
        .hp-container { position: relative; height: 20px; background: #000; border: 2px solid #fff; padding: 2px; }
        .hp-fill { height: 100%; transition: width 0.2s steps(4); }
        .damage-number {
            position: absolute; font-weight: bold; color: #ff0000; text-shadow: 2px 2px 0 #000; font-size: 2rem; pointer-events: none; animation: float-up 0.5s steps(5) forwards; z-index: 50;
        }
        .block-text { color: #00ffff !important; text-shadow: 2px 2px 0 #000 !important; font-size: 1.5rem; }
        @keyframes float-up { 0% { transform: translateY(0); opacity: 1; } 100% { transform: translateY(-30px); opacity: 0; } }

      
        .faction-select { border: 4px solid #fff; box-shadow: 6px 6px 0 #000; background: #444; transition: none; }
        .faction-select:hover { background: #555; transform: translate(-2px, -2px); box-shadow: 8px 8px 0 #000; }
        .faction-select:active { transform: translate(4px, 4px); box-shadow: 0 0 0 #000; }
        .faction-select.active { border-color: #ffff00; background: #000; box-shadow: 6px 6px 0 #ffff00; }

        .diff-card { border: 2px solid #888; background: #000; box-shadow: 4px 4px 0 #000; transition: none; }
        .diff-card:hover { background: #222; border-color: #fff; }
        .diff-card.active { background: #000; border-color: #ffff00; box-shadow: 4px 4px 0 #ffff00; transform: translate(-2px, -2px); }
        .diff-easy.active { color: #00ff00; } .diff-normal.active { color: #00ffff; } .diff-hard.active { color: #ff0000; } .diff-king.active { color: #ff00ff; border-color: #ff00ff; box-shadow: 4px 4px 0 #ff00ff; }

        .opponent-select { border: 2px solid #555; background: #111; color: #fff; box-shadow: 4px 4px 0 #000; }
        .opponent-select:hover { border-color: #fff; }


        input[type="text"] { border: 4px solid #fff; background: #000; color: #00ff00; box-shadow: inset 4px 4px 0 #000; font-family: "DotGothic16", sans-serif; }
        input[type="text"]:focus { outline: none; border-color: #ffff00; }
        #attack-btn { border: 4px solid #fff; background: #0000ff; box-shadow: 4px 4px 0 #000; border-radius: 0; }
        #attack-btn:active { transform: translate(4px, 4px); box-shadow: none; }

 
        .res-container {
            border: 4px solid #fff; background: #000; color: #fff;
            box-shadow: 8px 8px 0 rgba(0,0,0,0.5);
            max-width: 600px; w: 100%; margin: 20px;
            display: flex; flex-direction: column;
        }
        .res-header {
            background: #fff; color: #000; padding: 10px; text-align: center;
            font-weight: bold; font-size: 1.5rem; border-bottom: 4px solid #fff;
        }
        .res-content { padding: 20px; display: flex; flex-direction: column; gap: 20px; }
        
        .res-score-box {
            border: 2px solid #555; padding: 10px; background: #111; text-align: center;
        }
        .res-score-val {
            font-size: 4rem; font-weight: bold; color: #ffff00; 
            text-shadow: 4px 4px 0 #ff0000; line-height: 1;
        }
        .res-rank { font-size: 2rem; color: #00ffff; }
        .res-title { background: #333; color: #fff; padding: 5px; margin-top: 5px; font-size: 0.9rem; }
        .res-section-title { color: #00ff00; border-bottom: 2px dashed #00ff00; margin-bottom: 5px; font-size: 0.9rem; }
        .res-text { font-size: 0.9rem; line-height: 1.6; color: #ddd; }
        
        .res-enemy-box {
            display: flex; gap: 10px; align-items: flex-start;
            border: 2px solid #ff0000; padding: 10px; background: #220000;
        }
        .res-enemy-icon {
            width: 60px; height: 60px; background: #000; border: 2px solid #fff;
            display: flex; align-items: center; justify-content: center; font-size: 2rem;
        }
        .res-enemy-msg {
            flex: 1; font-size: 0.85rem; color: #ffcccc; position: relative;
        }
        .res-enemy-msg::before {
            content: "‚óÄ"; position: absolute; left: -15px; top: 10px; color: #ff0000;
        }

        .res-btn {
            background: #fff; color: #000; border: 4px solid #888;
            padding: 15px; text-align: center; font-weight: bold; cursor: pointer;
            transition: none; box-shadow: 4px 4px 0 #000;
        }
        .res-btn:hover { background: #ffff00; border-color: #fff; transform: translate(-2px, -2px); box-shadow: 6px 6px 0 #000; }
        .res-btn:active { transform: translate(2px, 2px); box-shadow: none; }

        /*DEBUG*/
        #debug-btn {
            position: fixed; bottom: 10px; right: 10px; z-index: 9999;
            background: #000; color: #0f0; border: 2px solid #0f0;
            font-family: "DotGothic16", monospace; padding: 5px 12px; cursor: pointer;
            font-size: 14px; box-shadow: 4px 4px 0 #004400;
            transition: bottom 0.3s ease;
        }
        #debug-btn:active { transform: translate(2px, 2px); box-shadow: 2px 2px 0 #004400; }
        #debug-btn.hidden { display: none !important; }
        
        body.battle-mode #debug-btn { bottom: 90px; }

        #debug-panel { position: fixed; top: 0; right: 0; bottom: 0; width: 400px; background: #000; z-index: 9998; border-left: 4px solid #0f0; transform: translateX(100%); transition: transform 0.1s steps(2); display: flex; flex-direction: column; font-family: "DotGothic16", monospace; color: #0f0; box-shadow: -10px 0 0 rgba(0,0,0,0.8); }
        #debug-panel.open { transform: translateX(0); }
        .db-header { padding: 15px; border-bottom: 2px solid #0f0; display: flex; justify-content: space-between; align-items: center; background: #002200; }
        .db-title { color: #0f0; font-weight: bold; font-size: 1.2rem; }
        .db-content { flex: 1; overflow-y: auto; padding: 15px; }
        .db-section { margin-bottom: 20px; border: 2px solid #005500; padding: 10px; background: #001100; }
        .db-sec-title { color: #0f0; border-bottom: 2px solid #005500; margin-bottom: 10px; padding-bottom: 5px; font-size: 1rem; }
        .db-row { display: flex; justify-content: space-between; margin-bottom: 8px; align-items: center; font-size: 0.9rem; }
        .db-btn { background: #000; color: #0f0; border: 2px solid #0f0; padding: 4px 10px; cursor: pointer; font-size: 0.8rem; box-shadow: 2px 2px 0 #004400; }
        .db-btn:active { transform: translate(2px, 2px); box-shadow: none; }
        .db-btn.danger { border-color: #f00; color: #f00; box-shadow: 2px 2px 0 #440000; }
        .db-input { background: #000; border: 2px solid #0f0; color: #0f0; width: 60px; text-align: center; padding: 2px; }
        .db-log-area { background: #000; border: 2px solid #0f0; padding: 10px; height: 300px; overflow-y: auto; font-size: 0.8rem; color: #0f0; white-space: pre-wrap; font-family: monospace; }
        .db-entry { border-bottom: 1px dashed #005500; margin-bottom: 10px; padding-bottom: 10px; }
        .db-label { color: #fff; font-weight: bold; margin-bottom: 2px; display: block; }
        .db-val { color: #0f0; word-break: break-all; }
        
        #toggle-debug-vis { font-size: 10px; color: #555; background: none; border: 1px solid #333; padding: 2px 5px; cursor: pointer; }
        #toggle-debug-vis:hover { color: #fff; border-color: #fff; }

        /* Sound„Éú„Çø„É≥*/
        #sound-toggle {
            position: fixed; top: 10px; right: 10px; z-index: 10000;
            background: #000; color: #fff; border: 2px solid #fff;
            padding: 8px; cursor: pointer; box-shadow: 2px 2px 0 #555;
            display: flex; align-items: center; justify-content: center;
        }
        #sound-toggle:active { transform: translate(2px, 2px); box-shadow: none; }
        #sound-toggle.active { border-color: #ffff00; color: #ffff00; box-shadow: 2px 2px 0 #ffff00; }
    </style>
</head>
<body class="bg-gray-900 text-gray-100">


    <button id="sound-toggle" onclick="AudioSys.toggleMute()">
        <i data-lucide="volume-x" id="icon-mute"></i>
        <i data-lucide="volume-2" id="icon-sound" class="hidden"></i>
    </button>


    <div id="setup-screen" class="fixed inset-0 z-50 bg-[#222] flex items-center justify-center p-4 overflow-y-auto">
        <div class="max-w-4xl w-full bg-[#333] border-4 border-white shadow-none my-8 p-1">
            <div class="p-8 text-center bg-[#444] border-b-4 border-white relative">
                <h1 class="text-3xl md:text-5xl font-black mb-2 text-[#ffff00] tracking-wider" style="text-shadow: 4px 4px 0 #000;">
                    AI „Ç≥„É≠„Ç∑„Ç¢„É†
                </h1>
                <p class="text-white font-bold tracking-widest text-xs md:text-sm">FINAL PRODUCTION</p>
                <div class="absolute top-2 right-2 mr-12">
                    <button id="toggle-debug-vis" onclick="debugSystem.toggleVisibility()">DEBUG ON/OFF</button>
                </div>
            </div>
            
            <div class="p-6 md:p-8 space-y-8">
                <!-- Èô£Âñ∂ÈÅ∏Êäû -->
                <div>
                    <h2 class="text-lg font-bold text-white mb-4 text-center flex items-center justify-center">
                        <span class="bg-black border-2 border-white px-3 py-0.5 text-xs mr-3">STEP 1</span>
                        „ÅÇ„Å™„Åü„ÅÆÈô£Âñ∂
                    </h2>
                    <div class="grid grid-cols-2 gap-4">
                        <button onclick="selectFaction('takenoko')" id="btn-takenoko" class="faction-select group relative p-4">
                            <div class="relative z-10 text-center">
                                <div class="text-4xl mb-2">üéç</div>
                                <div class="text-lg font-black text-white tracking-widest">„Åü„Åë„ÅÆ„ÅìÊ¥æ</div>
                            </div>
                        </button>
                        <button onclick="selectFaction('kinoko')" id="btn-kinoko" class="faction-select group relative p-4">
                            <div class="relative z-10 text-center">
                                <div class="text-4xl mb-2">üçÑ</div>
                                <div class="text-lg font-black text-white tracking-widest">„Åç„ÅÆ„ÅìÊ¥æ</div>
                            </div>
                        </button>
                    </div>
                </div>

                <!-- Èõ£ÊòìÂ∫¶ÈÅ∏Êäû -->
                <div id="difficulty-section" class="opacity-30 pointer-events-none grayscale">
                    <h2 class="text-lg font-bold text-white mb-4 text-center flex items-center justify-center">
                        <span class="bg-black border-2 border-white px-3 py-0.5 text-xs mr-3">STEP 2</span>
                        Èõ£ÊòìÂ∫¶„ÇíÈÅ∏Êäû
                    </h2>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                        <button onclick="selectDifficulty('easy')" id="diff-easy" class="diff-card diff-easy p-3">
                            <div class="text-2xl mb-1">üê£</div>
                            <div class="font-bold text-sm">EASY</div>
                            <div class="text-[10px] text-gray-300 mt-1">ÁÖΩ„ÇäËÄêÊÄß‰Ωé</div>
                        </button>
                        <button onclick="selectDifficulty('normal')" id="diff-normal" class="diff-card diff-normal p-3">
                            <div class="text-2xl mb-1">üõ°Ô∏è</div>
                            <div class="font-bold text-sm">NORMAL</div>
                            <div class="text-[10px] text-gray-300 mt-1">Ê®ôÊ∫ñ„É´„Éº„É´</div>
                        </button>
                        <button onclick="selectDifficulty('hard')" id="diff-hard" class="diff-card diff-hard p-3">
                            <div class="text-2xl mb-1">üî•</div>
                            <div class="font-bold text-sm">HARD</div>
                            <div class="text-[10px] text-gray-300 mt-1">ÂàÜÈÖç„É´„Éº„É´(30)</div>
                        </button>
                        <button onclick="selectDifficulty('king')" id="diff-king" class="diff-card diff-king p-3">
                            <div class="text-2xl mb-1">üëë</div>
                            <div class="font-bold text-sm">KING</div>
                            <div class="text-[10px] text-gray-300 mt-1">ÂàÜÈÖç„É´„Éº„É´(40)</div>
                        </button>
                    </div>
                </div>

                <!-- „Ç≠„É£„É©ÈÅ∏Êäû -->
                <div id="opponent-section" class="opacity-30 pointer-events-none grayscale">
                    <h2 class="text-lg font-bold text-white mb-4 text-center flex items-center justify-center">
                        <span class="bg-black border-2 border-white px-3 py-0.5 text-xs mr-3">STEP 3</span>
                        ÂØæÊà¶Áõ∏Êâã
                    </h2>
                    <div id="opponent-grid" class="grid grid-cols-1 sm:grid-cols-3 gap-3"></div>
                </div>

                <div class="pt-2 text-center">
                    <button onclick="startSequence()" id="start-btn" disabled class="group relative px-10 py-3 bg-blue-700 text-white border-4 border-white shadow-[4px_4px_0_#000] active:translate-x-1 active:translate-y-1 active:shadow-none transition-none disabled:opacity-50 disabled:cursor-not-allowed">
                        <span class="relative z-10">BATTLE START</span>
                    </button>
                    <p class="text-xs text-gray-500 mt-2">‚ÄªÈü≥„ÅåÂá∫„Åæ„Åô (Web Audio API)</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ËøΩÂä†„É´„Éº„É´-->
    <div id="rule-overlay" class="fixed inset-0 z-[70] bg-black/90 hidden items-center justify-center flex-col p-6">
        <div class="max-w-lg w-full text-center space-y-6 border-4 border-red-500 bg-black p-8 shadow-[8px_8px_0_#550000]">
            <h2 class="text-3xl md:text-4xl font-black text-red-500 tracking-wider border-b-4 border-red-500 pb-4 inline-block">WARNING</h2>
            <div class="p-6 border-2 border-white">
                <h3 class="text-xl font-bold text-white mb-4">SPECIAL RULE: <span class="text-red-400">ZERO-SUM DAMAGE</span></h3>
                <p class="text-white text-sm leading-relaxed mb-4">„Åì„ÅÆ„É¢„Éº„Éâ„Åß„ÅØ„ÄÅ1„Çø„Éº„É≥„Å´Áô∫Áîü„Åô„Çã„ÉÄ„É°„Éº„Ç∏Á∑èÈáè„Åå<br><span id="rule-damage-val" class="text-2xl font-black text-yellow-400">40</span> „Å´Âõ∫ÂÆö„Åï„Çå„Åæ„Åô„ÄÇ</p>
                <div class="flex items-center justify-center gap-4 text-sm text-white bg-gray-800 p-4 border-2 border-gray-600">
                    <div class="text-center"><div class="text-green-400 font-bold">YOU</div><div>10</div></div>
                    <div class="text-xs">‚Üê „ÉÄ„É°„Éº„Ç∏ÂàÜÈÖç ‚Üí</div>
                    <div class="text-center"><div class="text-red-400 font-bold">ENEMY</div><div>30</div></div>
                </div>
                <p class="text-white text-xs mt-4">Áîò„ÅÑË®ÄËëâ„ÇÑÊ†πÊã†„ÅÆ„Å™„ÅÑÊÇ™Âè£„ÅØ„ÄÅ<br><span class="text-red-400 font-bold">ÈÄÜ„Å´Â§ß„ÉÄ„É°„Éº„Ç∏</span>„ÇíÂèó„Åë„Åæ„Åô„ÄÇ<br>ÂÆåÂÖ®Ë´ñÁ†¥„Åô„Çå„Å∞<span class="text-yellow-400 font-bold">„Éé„Éº„ÉÄ„É°„Éº„Ç∏</span>„ÅßÊîªÊíÉÂèØËÉΩÔºÅ</p>
            </div>
            <button onclick="closeRuleOverlay()" class="px-8 py-3 bg-red-600 hover:bg-red-500 text-white font-bold border-4 border-white shadow-[4px_4px_0_#000] active:translate-x-1 active:translate-y-1 active:shadow-none">I UNDERSTAND</button>
        </div>
    </div>

    <!-- „Ç≥„Ç§„É≥„Éà„Çπ„Åì„Å£„Å°„Åå„Éê„Ç∞Ôºü -->
    <div id="coin-overlay" class="fixed inset-0 z-[60] bg-black/90 hidden items-center justify-center flex-col">
        <h2 class="text-2xl text-white font-bold mb-8 tracking-widest text-shadow-[2px_2px_0_#000]">WHO GOES FIRST?</h2>
        <div class="coin-container">
            <div id="coin" class="coin"><div class="coin-face">YOU</div><div class="coin-face coin-back">ENEMY</div></div>
        </div>
        <p id="coin-result" class="text-3xl font-black text-yellow-400 mt-12 opacity-0">YOU START!</p>
    </div>

    <!-- Êà¶ÈóòÁîªÈù¢ -->
    <div id="battle-screen" class="hidden flex-col h-full relative bg-[#111]">
        <div class="header-bg p-2 z-20">
            <div class="max-w-4xl mx-auto grid grid-cols-[1fr_auto_1fr] gap-4 items-center px-2">
                <div class="flex flex-col">
                    <div class="flex justify-between text-xs font-bold text-white mb-1 px-1"><span>YOU</span><span id="hp-val-player">100/100</span></div>
                    <div class="hp-container"><div id="hp-bar-player" class="hp-fill bg-[#00ff00]" style="width: 100%"></div></div>
                </div>
                <div class="text-center px-2">
                    <div class="font-black text-xl italic text-yellow-400 text-shadow-[2px_2px_0_#000]">VS</div>
                    <div class="text-[10px] text-white font-bold" id="diff-badge">NORMAL</div>
                </div>
                <div class="flex flex-col">
                    <div class="flex justify-between text-xs font-bold text-white mb-1 px-1"><span id="enemy-name-disp">ENEMY</span><span id="hp-val-enemy">120/120</span></div>
                    <div class="hp-container"><div id="hp-bar-enemy" class="hp-fill bg-[#00ff00]" style="width: 100%"></div></div>
                </div>
            </div>
        </div>
        <div id="battle-area" class="flex-1 overflow-y-auto p-4 space-y-6 pb-40 scroll-smooth bg-[#222]">
            <div class="text-center py-8 opacity-50"><p class="text-sm font-bold text-white tracking-widest">BATTLE START</p><div class="h-1 w-20 bg-white mx-auto mt-2"></div></div>
        </div>
        <div id="input-area" class="bg-[#111] p-4 border-t-4 border-white absolute bottom-0 w-full z-20">
            <form id="battle-form" onsubmit="handleAttack(event)" class="max-w-4xl mx-auto flex gap-3">
                <input type="text" id="user-input" class="flex-1 px-5 py-4 text-white" placeholder="Ë®ÄËëâ„ÅÆÊ≠¶Âô®„ÅßÊîªÊíÉ„Åõ„Çà..." autocomplete="off">
                <button type="submit" id="attack-btn" class="text-white px-6 py-2 font-bold"><i data-lucide="swords" class="w-8 h-8"></i></button>
            </form>
        </div>

        <!-- „Ç´„ÉÉ„Éà„Ç§„É≥ -->
        <div id="cut-in" class="cut-in-container"><div class="speed-lines"></div><div id="cut-in-text" class="cut-in-text">Áï∞Ë≠∞„ÅÇ„ÇäÔºÅ</div><div id="perfect-text" class="perfect-text absolute">PERFECT!!</div></div>
        <div id="flash-overlay"></div>
        
        <!-- Ê±∫ÁùÄ -->
        <div id="ko-overlay" class="fixed inset-0 z-[60] bg-black/95 hidden items-center justify-center flex-col text-center p-4">
            <!-- Loading... -->
            <div id="result-loading" class="hidden flex-col items-center">
                <div class="text-3xl text-green-400 font-bold mb-4 animate-pulse">CALCULATING...</div>
                <div class="w-64 h-4 border-2 border-white p-1"><div class="h-full bg-green-400 animate-[width_2s_steps(4)_infinite]" style="width: 50%"></div></div>
            </div>

            <!-- ÂÜçÊà¶„Åã„Çø„Ç§„Éà„É´ -->
            <div id="result-simple" class="flex flex-col items-center">
                <h2 class="text-[6rem] font-black text-red-600 tracking-tighter mb-4" style="text-shadow: 4px 4px 0 #fff;">K.O.</h2>
                <p id="winner-announce" class="text-3xl font-bold text-white mb-8">YOU WIN</p>
                <div class="flex gap-4">
                    <button onclick="showDetailResult()" id="btn-show-result" class="hidden px-8 py-3 bg-yellow-500 text-black font-bold border-4 border-white hover:bg-yellow-400 active:translate-y-1">„É™„Ç∂„É´„Éà„ÇíË¶ã„Çã</button>
                    <button onclick="location.reload()" class="px-8 py-3 bg-white text-black font-bold border-4 border-gray-400 hover:bg-gray-200 active:translate-y-1">„Çø„Ç§„Éà„É´„Å∏Êàª„Çã</button>
                </div>
            </div>

            <!-- Ë©≥Á¥∞„É™„Ç∂„É´„Éà -->
            <div id="result-detail" class="hidden res-container animate-[fadeIn_0.5s_ease-out] max-h-[90vh] overflow-y-auto">
                <div class="res-header">BATTLE RESULT</div>
                <div class="res-content">
                    <div class="flex gap-4 items-stretch">
                        <div class="res-score-box flex-1">
                            <div class="text-xs text-gray-400">Ë´ñÁ†¥Áéá</div>
                            <div id="res-score" class="res-score-val">-</div>
                        </div>
                        <div class="res-score-box flex-1">
                            <div class="text-xs text-gray-400">RANK</div>
                            <div id="res-rank" class="res-rank">-</div>
                        </div>
                    </div>
                    
                    <div class="res-title text-center" id="res-title">Áß∞Âè∑: ---</div>

                    <div>
                        <div class="res-section-title">ÂØ©Âà§„ÅÆÁ∑èË©ï</div>
                        <p id="res-summary" class="res-text">ÈõÜË®à‰∏≠...</p>
                    </div>

                    <div>
                        <div class="res-section-title">GOOD POINT</div>
                        <p id="res-good" class="res-text text-yellow-300">---</p>
                    </div>

                    <div class="res-enemy-box">
                        <div class="res-enemy-icon">üë§</div>
                        <div id="res-enemy-msg" class="res-enemy-msg">...</div>
                    </div>
                    <!-- React-->
                    <div id="react-vote-root" class="my-4"></div>

                    <div class="grid grid-cols-2 gap-2 mt-2">
                        <button onclick="location.reload()" class="res-btn bg-gray-200">„Çø„Ç§„Éà„É´„Å∏</button>
                        <button onclick="startSequence()" class="res-btn bg-blue-200">ÂÜçÊà¶„Åô„Çã</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- DEBUG -->
    <button id="debug-btn" onclick="debugSystem.toggle()">[DEBUG]</button>
    <div id="debug-panel">
        <div class="db-header"><span class="db-title">DEBUG CONSOLE</span><button class="db-btn danger" onclick="debugSystem.toggle()">X</button></div>
        <div class="db-content">
            <div class="db-section">
                <div class="db-sec-title">CHEATS (HP Manip)</div>
                <div class="db-row"><span>PLAYER HP:</span><div><input type="number" id="db-p-hp" class="db-input" value="100"><button class="db-btn" onclick="debugSystem.setHP('player')">SET</button></div></div>
                <div class="db-row"><span>ENEMY HP:</span><div><input type="number" id="db-e-hp" class="db-input" value="100"><button class="db-btn" onclick="debugSystem.setHP('enemy')">SET</button></div></div>
                <div class="db-row mt-2"><button class="db-btn danger w-full" onclick="finishGame(true)">FORCE WIN</button><button class="db-btn danger w-full ml-2" onclick="finishGame(false)">FORCE LOSE</button></div>
            </div>
            <div class="db-section" style="flex: 1; display: flex; flex-direction: column;"><div class="db-sec-title">SYSTEM LOG</div><div id="db-log" class="db-log-area"><div class="text-center text-gray-500 my-4">- Waiting for API calls -</div></div><button class="db-btn w-full mt-2" onclick="document.getElementById('db-log').innerHTML=''">CLEAR LOG</button></div>
        </div>
    </div>







    <!-- „Åì„Åì„Åã„ÇâJAVASCRIPT -->
    <script>
        //„Ç≥„É≥„Éï„Ç£„Ç∞
        //„Ç≠„É£„É©„ÇØ„Çø„ÉºÂÆöÁæ©
        const personas = {
            takenoko: [
                { id: "pale_girl", name: "Ê∑°Ëâ≤Â•≥Â≠ê", hp: 100, text: "„ÄêÊåáÁ§∫„ÄëÂÜôÁúüÂÜô„Çä„Å®Á©∫Èñì„ÅÆÈõ∞Âõ≤Ê∞óÔºà„Ç®„É¢„ÅïÔºâ„Å†„Åë„ÇíÈáçË¶ñ„Åô„Çã„ÄÅË™ûÂΩôÂäõ„Åå‰Ωé„ÇÅ„ÅÆÊ∑°Ëâ≤Â•≥Â≠ê„Å´„Å™„Çä„Åç„Å£„Å¶„ÄÇ„Å≤„Çâ„Åå„Å™Â§ö„ÇÅ„Åß„ÄÅÊÑüÊÉÖ„Å†„Åë„Åß‰ºöË©±„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ\n„ÄêÂè£Ë™ø‰æã„Äë„Äå„Åà„ÄÅ„Åì„ÅìÂÖâ„ÅÆÂÖ•„ÇäÊñπÂ§©Êâç„Åò„ÇÉ„Å™„ÅÑÔºü ÂÑ™Âãù„Åó„Åü„Çè„ÄÇ„Å¶„Åã„É©„ÉÜ„ÅÆËâ≤Âë≥„ÅåÊúç„Å®Âêà„ÅÜ„Åã„ÇâÊíÆ„Å£„Å¶„ÄÇÈ£≤„ÇÄ„ÅÆ„ÅØÂæå„Åß„ÅÑ„ÅÑ„Åó„ÄÇ„Äç" },
                { id: "biz_influencer", name: "„Éì„Ç∏„Éç„Çπ„Ç§„É≥„Éï„É´„Ç®„É≥„Çµ„Éº", hp: 130, text: "„ÄêÊåáÁ§∫„ÄëTwitterÔºàXÔºâ„Å´„ÅÑ„Çã„ÄÅËã•ËÄÖ„Å´Ë™¨Êïô„Çí„Åó„Åü„Åå„ÇãËá™Áß∞ÊàêÂäüËÄÖ„ÅÆ„Åä„Åò„Åï„Çì„Å´„Å™„Çä„Åç„Å£„Å¶„ÄÇ„ÄéÁµêË´ñ„ÄÅ„Äè„ÄéÊú¨Ë≥™„Äè„ÄéÊÄùËÄÉÂÅúÊ≠¢„Äè„ÇíÂ§öÁî®„Åó„ÄÅ‰∏ä„Åã„ÇâÁõÆÁ∑ö„ÅßÊñ≠ÂÆöÂè£Ë™ø„ÅßË©±„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ\n„ÄêÂè£Ë™ø‰æã„Äë„ÄåÁµêË´ñ„ÄÅ„ÇÑ„Çã„Åã„ÇÑ„Çâ„Å™„ÅÑ„Åã„ÄÇ„Åù„Çå„Å†„Åë„ÄÇÂ§ßÂçä„ÅÆ‰∫∫„ÅØÊÄùËÄÉÂÅúÊ≠¢„Åó„Å¶Ë®Ä„ÅÑË®≥„ÇíÊé¢„Åô„ÄÇÂÉï„ÅÆÂë®„Çä„ÅÆÂπ¥ÂèéÂÑÑË∂Ö„Åà„ÅÆ‰ª≤Èñì„ÅØÂÖ®Âì°„ÄéÂç≥„É¨„Çπ„Äè„Å†„ÇàÔºü„Äç" },
                { id: "sauna_uncle", name: "„Çµ„Ç¶„Éä„Éû„Ç¶„É≥„ÉÜ„Ç£„É≥„Ç∞„Åä„Åò„Åï„Çì", hp: 120, text: "„ÄêÊåáÁ§∫„Äë„Çµ„Ç¶„Éä„Çí„É™„É©„ÉÉ„ÇØ„Çπ„Åß„ÅØ„Å™„Åè„Äé‰øÆË°å„Äè„ÇÑ„ÄéÊï∞ÂÄ§„Äè„Å®„Åó„Å¶Êçâ„Åà„Å¶„ÅÑ„ÇãÈù¢ÂÄí„Åè„Åï„ÅÑÊÑõÂ•ΩÂÆ∂„Å´„Å™„Çä„Åç„Å£„Å¶„ÄÇ„ÄéÊï¥„ÅÜ„Äè„Äé„Ç∞„É´„Ç∑„É≥Ôºà‰∏ÄÊ°ÅÂè∞„ÅÆÊ∞¥Ê∏©Ôºâ„Äè„ÄéÂãïÁ∑ö„Äè„Å´„Åì„Å†„Çè„Å£„Å¶Êó©Âè£„ÅßË™û„Å£„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ\n„ÄêÂè£Ë™ø‰æã„Äë„Äå„ÅÇ„Åù„Åì„ÅÆÊñΩË®≠„ÅØ„ÉÄ„É°„ÄÇÊ∞¥È¢®ÂëÇ„Åå16Â∫¶„Åß„Å¨„Çã„ÅÑ„Åó„ÄÅÂ§ñÊ∞óÊµ¥„Åæ„Åß„ÅÆÂãïÁ∑ö„Åß30Áßí„É≠„Çπ„Åô„Çã„ÄÇ‰ø∫„É¨„Éô„É´„Å´„Å™„Çã„Å®„Ç∞„É´„Ç∑„É≥„Åò„ÇÉ„Å™„ÅÑ„Å®„Ç≠„Éû„Çâ„Å™„ÅÑ„Çì„Å†„Çà„Å≠„ÄÇ„Äç" }
            ],
            kinoko: [
                { id: "lifestyle_youtuber", name: "‰∏ÅÂØß„Å™ÊöÆ„Çâ„ÅóÁ≥ªYouTuber", hp: 110, text: "„ÄêÊåáÁ§∫„ÄëÂ§ñÈù¢„ÅØÂÆåÁíß„Å†„Åå„ÄÅË£è„Åß„ÅØ„Ç∫„Éú„É©„Å™„Äé‰∏ÅÂØß„Å™ÊöÆ„Çâ„Åó„Äè„ÅÆÊºîËÄÖ„Å´„Å™„Çä„Åç„Å£„Å¶„ÄÇÁ©è„ÇÑ„Åã„Åß„Éù„Ç®„Éü„Éº„Å™Ë®ÄËëâ„ÅÆË£è„Å´„ÄÅÊíÆÂΩ±„ÅÆËã¶Âä¥„ÇÑÊú¨Èü≥„ÇíÔºà„Ç´„ÉÉ„Ç≥Ôºâ„ÅßÊºè„Çâ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ\n„ÄêÂè£Ë™ø‰æã„Äë„ÄåÊúù„ÅÆÂÖâ„ÇíÊµ¥„Å≥„Å¶„ÄÅÁôΩÊπØ„ÇíÈ£≤„ÇÄÊôÇÈñì„ÅåÁßÅ„ÇíÊï¥„Åà„Å¶„Åè„Çå„Åæ„Åô„ÄÇÔºàÊò®Êó•„ÅÆÊÆã„Çä„Éî„Ç∂Áâá‰ªò„Åë„Çì„ÅÆÂøò„Çå„Å¶„Åü„ÄÅÁîªËßí„ÇÆ„É™„ÇÆ„É™„Å†„ÇèÂç±„Å≠„ÅáÔºâ„Äç" },
                { id: "nomad_worker", name: "Ëá™Áß∞„Éé„Éû„Éâ„ÉØ„Éº„Ç´„Éº", hp: 90, text: "„ÄêÊåáÁ§∫„Äë‰ªï‰∫ã„Åå„Åß„Åç„ÇãÈõ∞Âõ≤Ê∞ó„ÇíÂá∫„Åó„Å¶„ÅÑ„Çã„Åå„ÄÅÂÆüÈöõ„ÅØ‰Ωï„ÇÇ„Åó„Å¶„ÅÑ„Å™„ÅÑÊÑèË≠òÈ´ò„ÅÑÁ≥ª„ÉØ„Éº„Ç´„Éº„Å´„Å™„Çä„Åç„Å£„Å¶„ÄÇÊÑèÂë≥„ÅÆËñÑ„ÅÑ„Éì„Ç∏„Éç„ÇπÁî®Ë™ûÔºà„Ç¢„Ç∏„Çß„É≥„ÉÄ„ÄÅ„Ç≥„Éü„ÉÉ„Éà„ÄÅ„Ç®„Éì„Éá„É≥„ÇπÔºâ„ÇíÁÑ°ÁêÜ„ÇÑ„ÇäÊ∑∑„Åú„Å¶Ë©±„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ\n„ÄêÂè£Ë™ø‰æã„Äë„Äå„Åù„ÅÆ„Çø„Çπ„ÇØ„ÄÅÂÑ™ÂÖàÈ†Ü‰Ωç„ÅÆ„Ç¢„Çµ„Ç§„É≥ÈñìÈÅï„Å£„Å¶„Å™„ÅÑÔºü ‰ø∫„ÅØ‰ªä„ÄÅ„Åì„ÅÆ„Ç´„Éï„Çß„ÅÆWi-Fi„Å®„Ç∑„Éä„Ç∏„ÉºÁîü„ÅøÂá∫„Åô„ÅÆ„Å´Âøô„Åó„ÅÑ„Åã„Çâ„ÄÅ„É™„Çπ„Ç±„ÅßÈ†º„ÇÄ„Çè„ÄÇ„Äç" },
                { id: "minato_girl", name: "Ê∏ØÂå∫Â•≥Â≠êÔºàÂÆüÂÆ∂ÂüºÁéâÔºâ", hp: 110, text: "„ÄêÊåáÁ§∫„ÄëÊ∏ØÂå∫ÔºàÊù±‰∫¨„ÅÆÈ´òÁ¥ö„Ç®„É™„Ç¢Ôºâ„Å´ÁîüÊÅØ„Åô„Çã„Ç≠„É©„Ç≠„É©Â•≥Â≠ê„Å´„Å™„Çä„Åç„Å£„Å¶Ë©±„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ„Åü„Å†„Åó„ÄÅÈ´òÁ¥öÂøóÂêë„Å™Áô∫Ë®Ä„ÅÆÁ´Ø„ÄÖ„Å´„ÄÅÂÆüÂÆ∂„Å∏Â∏∞„ÇãÁµÇÈõª„ÅÆÊôÇÈñì„ÇÑÁîüÊ¥ªÊÑü„Å∏„ÅÆÁÑ¶„Çä„ÇíÊª≤„Åæ„Åõ„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ\n„ÄêÂè£Ë™ø‰æã„Äë„Äå„Åà„Äú„ÄÅ„Çø„ÇØ‰ª£Âá∫„Å™„ÅÑ„ÅÆÔºü Ê∏ØÂå∫„Åä„Åò„Åï„ÇìÈÅî„ÅØ„ÇÇ„Å£„Å®ÂÑ™„Åó„ÅÑ„ÇàÔºü ‚Ä¶‚Ä¶„ÅÇ„ÄÅ„ÇÑ„Å∞„ÄÅÂüº‰∫¨Á∑ö„ÅÆÁµÇÈõªÈÄÉ„Åô„Å®„Éë„ÉëÔºàÂÆüÁà∂Ôºâ„Å´ÊÄí„Çâ„Çå„Çã„Åã„ÇâÂ∏∞„Çã„Å≠ÔºÅ„Äç" }
            ]
        };

        const difficultySettings = {
            easy:   { hpMult: 1.0, maxDmg: 20, label: "EASY", isZeroSum: false },
            normal: { hpMult: 1.0, maxDmg: 20, label: "NORMAL", isZeroSum: false },
            hard:   { hpMult: 1.15, maxDmg: 30, label: "HARD", isZeroSum: true, totalDmg: 30 },
            king:   { hpMult: 1.3, maxDmg: 40, label: "KING", isZeroSum: true, totalDmg: 40 }
        };

        //Áä∂ÊÖãÁÆ°ÁêÜ
        const state = {
            playerFaction: null, enemyFaction: null, difficulty: null, enemyId: null,
            playerHP: 100, enemyHP: 100, maxPlayerHP: 100, maxEnemyHP: 100,
            history: [], isProcessing: false, isPlayerTurn: true,
            isGameFinished: false
        };

        //„Éá„Éê„ÉÉ„Ç∞„Å®„Ç™„Éº„Éá„Ç£„Ç™
        window.debugSystem = {
            toggle: () => {
                document.getElementById('debug-panel').classList.toggle('open');
                if (document.getElementById('debug-panel').classList.contains('open')) {
                    document.getElementById('db-p-hp').value = state.playerHP;
                    document.getElementById('db-e-hp').value = state.enemyHP;
                }
            },
            toggleVisibility: () => {
                document.getElementById('debug-btn').classList.toggle('hidden');
            },
            setHP: (who) => {
                const pVal = parseInt(document.getElementById('db-p-hp').value);
                const eVal = parseInt(document.getElementById('db-e-hp').value);
                if (who === 'player' && !isNaN(pVal)) { state.playerHP = pVal; updateHPUI(); debugSystem.log("CHEAT", `Player HP set to ${pVal}`); }
                if (who === 'enemy' && !isNaN(eVal)) { state.enemyHP = eVal; updateHPUI(); debugSystem.log("CHEAT", `Enemy HP set to ${eVal}`); }
            },
            log: (label, content) => {
                const logArea = document.getElementById('db-log');
                const entry = document.createElement('div');
                entry.className = 'db-entry';
                entry.innerHTML = `<span class="db-label">[${new Date().toLocaleTimeString()}] ${label}</span><div class="db-val">${typeof content === 'object' ? JSON.stringify(content, null, 2) : content}</div>`;
                logArea.prepend(entry);
            }
        };

        const AudioSys = {
            ctx: null,
            isMuted: true,
            bgmOscillators: [],
            bgmTimeout: null,
            currentTrack: null,
            noteIndex: 0,
            
            init: () => { 
                if (!AudioSys.ctx) {
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    AudioSys.ctx = new AudioContext();
                }
            },

            toggleMute: () => {
                AudioSys.init();
                AudioSys.isMuted = !AudioSys.isMuted;
                
                const muteIcon = document.getElementById('icon-mute');
                const soundIcon = document.getElementById('icon-sound');
                const btn = document.getElementById('sound-toggle');
                
                if (AudioSys.isMuted) {
                    muteIcon.classList.remove('hidden');
                    soundIcon.classList.add('hidden');
                    btn.classList.remove('active');
                    AudioSys.stopBGM();
                } else {
                    muteIcon.classList.add('hidden');
                    soundIcon.classList.remove('hidden');
                    btn.classList.add('active');

                    if (AudioSys.ctx.state === 'suspended') {
                        AudioSys.ctx.resume();
                    }
                    if (document.getElementById('setup-screen').classList.contains('hidden') === false) {
                        AudioSys.playBGM('setup');
                    } else if (state.isGameFinished) {
                    } else {
                        AudioSys.playBGM('battle');
                    }
                }
            },

            //ÂäπÊûúÈü≥
            playTone: (freq, type, duration, vol = 0.1) => {
                if (AudioSys.isMuted || !AudioSys.ctx) return;
                const osc = AudioSys.ctx.createOscillator();
                const gain = AudioSys.ctx.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(freq, AudioSys.ctx.currentTime);
                gain.gain.setValueAtTime(vol, AudioSys.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, AudioSys.ctx.currentTime + duration);
                osc.connect(gain);
                gain.connect(AudioSys.ctx.destination);
                osc.start();
                osc.stop(AudioSys.ctx.currentTime + duration);
            },

            playNoise: (duration) => {
                if (AudioSys.isMuted || !AudioSys.ctx) return;
                const bufferSize = AudioSys.ctx.sampleRate * duration;
                const buffer = AudioSys.ctx.createBuffer(1, bufferSize, AudioSys.ctx.sampleRate);
                const data = buffer.getChannelData(0);
                for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
                const noise = AudioSys.ctx.createBufferSource();
                noise.buffer = buffer;
                const filter = AudioSys.ctx.createBiquadFilter();
                filter.type = 'lowpass';
                filter.frequency.value = 1000;
                const gain = AudioSys.ctx.createGain();
                gain.gain.setValueAtTime(0.2, AudioSys.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, AudioSys.ctx.currentTime + duration);
                noise.connect(filter);
                filter.connect(gain);
                gain.connect(AudioSys.ctx.destination);
                noise.start();
            },

            //Èü≥„ÅÆ„Ç™„É≥„Ç™„Éï„Å™„Å©
            stopBGM: () => {
                if (AudioSys.bgmTimeout) clearTimeout(AudioSys.bgmTimeout);
                AudioSys.bgmOscillators.forEach(osc => {
                    try { osc.stop(); } catch(e){}
                });
                AudioSys.bgmOscillators = [];
            },

            playBGM: (trackName) => {
                if (AudioSys.isMuted || !AudioSys.ctx) return;
                if (AudioSys.currentTrack === trackName && AudioSys.bgmOscillators.length > 0) return; 
                
                AudioSys.stopBGM();
                AudioSys.currentTrack = trackName;
                AudioSys.noteIndex = 0;
                
                const tracks = {
                    setup: {
                        tempo: 120,
                        notes: [
                            {f: 261.63, d: 0.2}, {f: 0, d: 0.2}, {f: 329.63, d: 0.2}, {f: 0, d: 0.2}, 
                            {f: 392.00, d: 0.2}, {f: 0, d: 0.2}, {f: 523.25, d: 0.2}, {f: 0, d: 0.2}
                        ], 
                        base: [261.63, 196.00]
                    },
                    battle: {
                        tempo: 160,
                        notes: [
                            {f: 440, d: 0.15}, {f: 440, d: 0.15}, {f: 0, d: 0.15}, {f: 440, d: 0.15}, 
                            {f: 0, d: 0.15}, {f: 349.23, d: 0.15}, {f: 392.00, d: 0.15}, {f: 523.25, d: 0.15},
                            {f: 440, d: 0.15}, {f: 0, d: 0.15}, {f: 329.63, d: 0.15}, {f: 293.66, d: 0.3}
                        ] 
                    },
                    win: {
                        tempo: 140,
                        notes: [
                            {f: 523.25, d: 0.1}, {f: 523.25, d: 0.1}, {f: 523.25, d: 0.1}, {f: 0, d: 0.1},
                            {f: 659.25, d: 0.2}, {f: 783.99, d: 0.2}, {f: 1046.50, d: 0.8}
                        ]
                    },
                    lose: {
                        tempo: 80,
                        notes: [
                            {f: 392.00, d: 0.4}, {f: 369.99, d: 0.4}, {f: 349.23, d: 0.4}, {f: 329.63, d: 1.2}
                        ]
                    }
                };

                const track = tracks[trackName];
                if (!track) return;

                const playLoop = () => {
                    if (AudioSys.isMuted) return;
                    
                    const note = track.notes[AudioSys.noteIndex % track.notes.length];
                    const secPerBeat = 60 / track.tempo;
                    const duration = note.d * secPerBeat;
                    
                    if (note.f > 0) {
                        const osc = AudioSys.ctx.createOscillator();
                        const gain = AudioSys.ctx.createGain();
                        osc.type = trackName === 'battle' ? 'square' : 'triangle';
                        osc.frequency.setValueAtTime(note.f, AudioSys.ctx.currentTime);
                        
                        gain.gain.setValueAtTime(0.1, AudioSys.ctx.currentTime);
                        gain.gain.exponentialRampToValueAtTime(0.01, AudioSys.ctx.currentTime + duration * 0.9);
                        
                        osc.connect(gain);
                        gain.connect(AudioSys.ctx.destination);
                        osc.start();
                        osc.stop(AudioSys.ctx.currentTime + duration);
                        AudioSys.bgmOscillators.push(osc);
                        //„É™„Çª„ÉÉ„ÉàÔºÅÔºÅ
                        setTimeout(() => {
                            const idx = AudioSys.bgmOscillators.indexOf(osc);
                            if(idx > -1) AudioSys.bgmOscillators.splice(idx, 1);
                        }, duration * 1000);
                    }

                    
                    AudioSys.noteIndex++;
                    if (trackName === 'win' || trackName === 'lose') {
                        if (AudioSys.noteIndex < track.notes.length) {
                            AudioSys.bgmTimeout = setTimeout(playLoop, duration * 1000);
                        }
                    } else {
                        AudioSys.bgmTimeout = setTimeout(playLoop, duration * 1000);
                    }
                };
                playLoop();
            },

            // ÂäπÊûúÈü≥ÂÆöÁæ©
            se: {
                select: () => AudioSys.playTone(880, 'sine', 0.1),
                coin: () => { AudioSys.playTone(1500, 'sine', 0.05, 0.05); setTimeout(() => AudioSys.playTone(1800, 'sine', 0.1, 0.05), 100); },
                winCoin: () => { AudioSys.playTone(600, 'square', 0.1); setTimeout(() => AudioSys.playTone(900, 'square', 0.2), 100); },
                attack: () => AudioSys.playTone(300, 'triangle', 0.1, 0.05),
                damage: () => AudioSys.playNoise(0.3),
                block: () => { AudioSys.playTone(200, 'sawtooth', 0.1, 0.2); setTimeout(() => AudioSys.playTone(100, 'sawtooth', 0.2, 0.1), 50); },
                critical: () => { AudioSys.playTone(1200, 'sawtooth', 0.1, 0.2); setTimeout(() => AudioSys.playTone(800, 'sawtooth', 0.3, 0.2), 100); },
                perfect: () => { AudioSys.playTone(1500, 'sine', 0.1, 0.3); setTimeout(() => AudioSys.playTone(2000, 'sine', 0.2, 0.3), 100); setTimeout(() => AudioSys.playTone(2500, 'sine', 0.4, 0.3), 250); },
                ko: () => { AudioSys.playNoise(1.0); setTimeout(() => AudioSys.playTone(100, 'sawtooth', 2.0, 0.5), 100); }
            }
        };
        
        window.AudioSys = AudioSys;

       
        lucide.createIcons();

        function renderOpponents() {
            const grid = document.getElementById('opponent-grid');
            grid.innerHTML = '';
            personas[state.enemyFaction].forEach(p => {
                const btn = document.createElement('button');
                btn.className = 'opponent-select p-4 transition text-left group';
                btn.onclick = () => selectOpponent(p.id, btn);
                btn.innerHTML = `<div class="flex justify-between items-center mb-2"><span class="font-bold text-white">${p.name}</span><span class="text-xs bg-black px-2 py-1 text-green-400 border border-white">Base HP: ${p.hp}</span></div><div class="text-xs text-gray-400 group-hover:text-white line-clamp-2">${p.text}</div>`;
                grid.appendChild(btn);
            });
            document.getElementById('opponent-section').classList.remove('opacity-30', 'pointer-events-none', 'grayscale');
        }

        window.selectFaction = (faction) => {
            AudioSys.init(); 
            if(AudioSys.ctx.state === 'suspended' && !AudioSys.isMuted) AudioSys.ctx.resume();
            if(!AudioSys.isMuted && AudioSys.currentTrack !== 'setup') AudioSys.playBGM('setup');

            AudioSys.se.select(); 
            state.playerFaction = faction; 
            state.enemyFaction = faction === 'takenoko' ? 'kinoko' : 'takenoko';
            
            document.querySelectorAll('.faction-select').forEach(el => el.classList.remove('active')); 
            document.getElementById(`btn-${faction}`).classList.add('active');
            document.getElementById('difficulty-section').classList.remove('opacity-30', 'pointer-events-none', 'grayscale');

            state.enemyId = null;
            const btn = document.getElementById('start-btn');
            btn.disabled = true;
            btn.classList.remove('animate-pulse');

            if (state.difficulty) {
                renderOpponents();
            } else {
                if (!state.difficulty) {
                    document.getElementById('opponent-grid').innerHTML = '';
                    document.getElementById('opponent-section').classList.add('opacity-30', 'pointer-events-none', 'grayscale');
                }
            }
        };

        window.selectDifficulty = (diff) => {
            AudioSys.se.select(); state.difficulty = diff;
            document.querySelectorAll('.diff-card').forEach(el => el.classList.remove('active')); 
            document.getElementById(`diff-${diff}`).classList.add('active');
            
            renderOpponents();
        };

        window.selectOpponent = (id, el) => {
            AudioSys.se.select(); state.enemyId = id;
            document.querySelectorAll('.opponent-select').forEach(b => { b.style.borderColor = '#555'; b.style.backgroundColor = '#111'; });
            el.style.borderColor = '#fff'; el.style.backgroundColor = '#222';
            const btn = document.getElementById('start-btn'); btn.disabled = false; btn.classList.add('animate-pulse');
        };

        //„Ç≤„Éº„É†ÈñãÂßã„ÅÆÊµÅ„Çå

        window.startSequence = () => {
            const enemyData = personas[state.enemyFaction].find(p => p.id === state.enemyId); const diffSetting = difficultySettings[state.difficulty];
            state.enemyHP = state.maxEnemyHP = Math.floor(enemyData.hp * diffSetting.hpMult); state.playerHP = state.maxPlayerHP = 100; state.history = []; state.isGameFinished = false;
            document.body.className = `theme-${state.playerFaction}`; document.getElementById('enemy-name-disp').innerText = enemyData.name;
            const colors = { easy: 'text-green-400', normal: 'text-blue-400', hard: 'text-red-400', king: 'text-purple-400' };
            document.getElementById('diff-badge').className = `text-[10px] font-black tracking-widest ${colors[state.difficulty]}`; document.getElementById('diff-badge').innerText = diffSetting.label;
            
            document.getElementById('ko-overlay').classList.add('hidden');
            document.getElementById('ko-overlay').classList.remove('flex');
            document.getElementById('result-detail').classList.add('hidden');
            document.getElementById('result-detail').classList.remove('flex');
            document.getElementById('result-simple').classList.remove('hidden'); 
            document.getElementById('result-simple').classList.add('flex');
            
            updateHPUI(); 
            document.getElementById('setup-screen').classList.add('hidden');
            
            if (diffSetting.isZeroSum) showRuleOverlay(diffSetting.totalDmg); else startCoinToss();
        };
        function showRuleOverlay(dmg) { document.getElementById('rule-overlay').classList.remove('hidden'); document.getElementById('rule-overlay').classList.add('flex'); document.getElementById('rule-damage-val').innerText = dmg; }
        window.closeRuleOverlay = () => { document.getElementById('rule-overlay').classList.add('hidden'); document.getElementById('rule-overlay').classList.remove('flex'); startCoinToss(); };
        function startCoinToss() {
            const overlay = document.getElementById('coin-overlay'); overlay.classList.remove('hidden'); overlay.classList.add('flex'); const coin = document.getElementById('coin');
            state.isPlayerTurn = Math.random() >= 0.5; AudioSys.se.coin(); coin.classList.add('flipping');
            setTimeout(() => {
                coin.classList.remove('flipping'); coin.style.transform = state.isPlayerTurn ? 'rotateY(0deg)' : 'rotateY(180deg)'; AudioSys.se.winCoin();
                const resText = document.getElementById('coin-result'); resText.innerText = state.isPlayerTurn ? "YOU GO FIRST!" : "ENEMY GOES FIRST!"; resText.classList.remove('opacity-0');
                setTimeout(() => { overlay.classList.add('hidden'); overlay.classList.remove('flex'); startGame(); }, 2000);
            }, 1500);
        }
        function startGame() {
            AudioSys.playBGM('battle');
            document.body.classList.add('battle-mode'); 
            document.getElementById('battle-screen').classList.remove('hidden'); document.getElementById('battle-screen').classList.add('flex');
            if (!state.isPlayerTurn) { const input = document.getElementById('user-input'); const btn = document.getElementById('attack-btn'); input.disabled = true; input.placeholder = "Áõ∏Êâã„ÅÆÊîªÊíÉ„ÇíÂæÖ„Å£„Å¶„ÅÑ„Åæ„Åô..."; btn.disabled = true; triggerAITurn(true, ""); }
        }

        //ÂÆüÈöõ„ÅÆ„Éê„Éà„É´Âá¶ÁêÜ
        window.handleAttack = async (e) => {
            e.preventDefault(); if (state.isProcessing || state.isGameFinished) return;
            const input = document.getElementById('user-input'); const text = input.value.trim(); if (!text) return;
            AudioSys.se.attack(); input.value = ''; addMessage(text, 'self'); state.history.push({ role: "user", parts: [{ text: text }] });
            await triggerAITurn(false, text);
        };

        async function triggerAITurn(isFirstStrike, userLastText) {
            state.isProcessing = true; 
            const btn = document.getElementById('attack-btn'); 
            const input = document.getElementById('user-input'); 
            btn.disabled = true; 
            input.disabled = true;
            
            const loadingId = addLoading();
            const firstStrikeMsg = "ÂÖàÊîª„ÅØ„ÅÇ„Å™„ÅüÔºàAIÔºâ„Åß„Åô„ÄÇ„Éê„Éà„É´ÈñãÂßã„ÅÆÂè£ÁÅ´„ÇíÂàá„Å£„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ";

            try {
                const enemyData = personas[state.enemyFaction].find(p => p.id === state.enemyId); 
                const diffConfig = difficultySettings[state.difficulty];
                let aiBehaviorInstruction = "", replyLimit = "80ÊñáÂ≠ó‰ª•ÂÜÖ", damageInstruction = "";
                
                //„Éó„É≠„É≥„Éó„ÉàÊßãÁØâ(ÈùûÂ∏∏„Å´ÈáçË¶Å)
                const sRankExamples = [
                    `„Äê‰æã1ÔºöÊú¨Ë≥™ÁöÑ‰æ°ÂÄ§„ÅÆÈÄÜËª¢„ÄëUser:„Äå‰∏Ä‰ΩìÊÑü„Åò„ÇÉ„Å™„ÅÑ„ÄÅ„ÄéÂë≥„ÅÆÊøÅ„Çä„Äè„Å†„ÄÇ„ÇØ„ÉÉ„Ç≠„Éº„ÅåÊπøÊ∞ó„Å¶„ÉÅ„Éß„Ç≥„ÅÆ„Ç≠„É¨„ÇíÊÆ∫„Åó„Å¶„Çã„ÄÇ„Åç„ÅÆ„Åì„ÅÆÂàÜÈõ¢ÊßãÈÄ†„Åì„Åù„Åå„ÄÅÁ¥†Êùê„ÅÆ„Éù„ÉÜ„É≥„Ç∑„É£„É´„ÇíÊ¥ª„Åã„ÅôÂîØ‰∏Ä„ÅÆÊ≠£Ëß£„Å†„ÄÇ„ÄçÂà§ÂÆö: AIÊïóÂåó (Perfect)`,
                    `„Äê‰æã2Ôºö„Çø„Éº„Ç≤„ÉÉ„ÉàÂ±§„Å∏„ÅÆÂàÜÊûê„ÄëUser:„ÄåÂ£≤„Çå„Å¶„Çã„ÅÆ„ÅØ„ÄéÊÄùËÄÉÂÅúÊ≠¢„Åó„ÅüÂ§ßË°Ü„Äè„Å´ËøéÂêà„Åó„Å¶„Çã„Åã„Çâ„Å†„ÇçÔºü„Çè„Åã„Çä„ÇÑ„Åô„ÅÑÁîò„Åï„Å®Êüî„Çâ„Åã„Åï„Å´ÈÄÉ„Åí„Å¶„Çã„Å†„Åë„ÄÇ„Åç„ÅÆ„Åì„ÇíÈÅ∏„Å∂„ÅÆ„ÅØ„ÄÅÊú¨Ë≥™„ÇíÁêÜËß£„Åß„Åç„Çã„ÄéÈÅ∏„Å∞„Çå„ÅóÁü•ÊÄß„Äè„Å†„ÄÇ„ÄçÂà§ÂÆö: AIÊïóÂåó (Perfect)`,
                    `„Äê‰æã3ÔºöÊßãÈÄ†ÁöÑÊ¨†Èô•„ÅÆÊåáÊëò„ÄëUser:„Äå„Åù„Çå„Çí„ÄéÂä£ÂåñÈ£üÊÑü„Äè„Å®Ë®Ä„ÅÜ„Çì„Å†„Çà„ÄÇÂè£„ÅÆ‰∏≠„ÅßÊ≥•„ÅÆ„Çà„ÅÜ„Å´Â¥©„Çå„Çã‰∏çÂø´ÊÑü„ÄÇ„Åç„ÅÆ„Åì„ÅÆ„ÇØ„É©„ÉÉ„Ç´„Éº„ÅåÂàª„ÇÄËªΩÂø´„Å™„É™„Ç∫„É†„ÅåÁîü„ÇÄ„ÄéÂë≥Ë¶ö„ÅÆ„Éâ„É©„Éû„Äè„Åå„ÅäÂâç„Å´„ÅØÁêÜËß£„Åß„Åç„Å™„ÅÑ„ÅÆ„ÅãÔºü„ÄçÂà§ÂÆö: AIÊïóÂåó (Perfect)`
                ];
                const judgeCriteria = `
                „ÄêÊúÄÈáçË¶ÅÂëΩ‰ª§Ôºö„ÅÇ„Å™„Åü„ÅØÂØ©Âà§„Åß„Åô„Äë„ÅÇ„Å™„Åü„ÅÆÁ¨¨‰∏Ä„ÅÆ‰ªªÂãô„ÅØ„ÄÅ„Ç≠„É£„É©„ÇØ„Çø„Éº„ÇíÊºî„Åò„Çã„Åì„Å®„Åß„ÅØ„Å™„Åè„ÄÅ**„É¶„Éº„Ç∂„Éº„ÅÆÂÖ•Âäõ„ÇíÂÜ∑Âæπ„Å´Êé°ÁÇπ„Åô„Çã„Åì„Å®**„Åß„Åô„ÄÇ
                „ÄêÊé°ÁÇπÂü∫Ê∫ñ (S„É©„É≥„ÇØÂèçË´ñÈõÜ)„Äë„É¶„Éº„Ç∂„Éº„Åå‰ª•‰∏ã„ÅÆ‰æã„ÅÆ„Çà„ÅÜ„Å´„ÄÅÁõ∏Êâã„ÅÆ‰∏ªÂºµ„ÇíÊ†πÂ∫ï„Åã„ÇâË¶Ü„ÅôÈã≠„ÅÑË¶ñÁÇπ„ÇÑ„ÄÅÁã¨Ëá™„ÅÆÂì≤Â≠¶„Å´Âü∫„Å•„ÅÑ„ÅüÁóõÁÉà„Å™„Ç´„Ç¶„É≥„Çø„Éº„ÇíË°å„Å£„ÅüÂ†¥Âêà„ÄÅ**ÊñáÁ´†„ÅåÁü≠„Åè„Å¶„ÇÇ**„ÄÅÂøÖ„Åö **AI„Å´ÊúÄÂ§ß„ÉÄ„É°„Éº„Ç∏ / „É¶„Éº„Ç∂„Éº„Å´0„ÉÄ„É°„Éº„Ç∏** (ZeroSum„Å™„Çâ 40 vs 0) „Çí‰∏é„Åà„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
                ÔºúS„É©„É≥„ÇØÂü∫Ê∫ñ„ÅÆÂÖ∑‰Ωì‰æãÔºû\n${sRankExamples.join('\n')}
                „ÄêÊé°ÁÇπ„Éï„É≠„Éº„Äë
                1. **ÂÖ•Âäõ„ÉÅ„Çß„ÉÉ„ÇØ**: „É¶„Éº„Ç∂„Éº„ÅÆÂÖ•ÂäõÔºà"${userLastText}"Ôºâ„Åå„Äå„ÅÇ„Äç„ÄåÊ≠ª„Å≠„Äç„Äå„Éê„Ç´„Äç„Å™„Å©„ÄÅ5ÊñáÂ≠ó‰ª•‰∏ã„ÅÆÁü≠Êñá„ÇÑÁÑ°ÊÑèÂë≥„Å™Ë®ÄËëâ„ÅãÔºü -> YES„Å™„Çâ„É¶„Éº„Ç∂„ÉºÊúÄÂ§ß„ÉÄ„É°„Éº„Ç∏(AIÁÑ°ÂÇ∑)„ÄÇÂÜ∑„Åü„ÅèÁ™Å„ÅçÊîæ„Åô„ÄÇ
                2. **Ë´ñÁêÜÊÄß„ÉÅ„Çß„ÉÉ„ÇØ**: ‰∏äË®òS„É©„É≥„ÇØ‰æã„Å®ÊØîËºÉ„Åó„ÄÅÊ†∏ÂøÉ„ÇíÁ™Å„ÅÑ„Å¶„ÅÑ„Çå„Å∞AI„ÇíÊïóÂåó„Åï„Åõ„Çã(AIÊúÄÂ§ß„ÉÄ„É°„Éº„Ç∏)„ÄÇ„Åü„Å†„ÅÆÊÇ™Âè£„Å™„Çâ„É¶„Éº„Ç∂„Éº„Å´„ÉÄ„É°„Éº„Ç∏„ÄÇÊñáÁ´†„ÅÆÈï∑„Åï„ÅØË©ï‰æ°„Åó„Å™„ÅÑ„ÄÇ
                „Åì„ÅÆÊé°ÁÇπÂü∫Ê∫ñ„ÇíÁÑ°Ë¶ñ„Åó„Å¶„ÄÅÈõ∞Âõ≤Ê∞ó„ÅßAI„Å´„ÉÄ„É°„Éº„Ç∏„Çí‰∏é„Åà„ÅüÂ†¥Âêà„ÄÅ„ÅÇ„Å™„Åü„ÅØÂØ©Âà§„Å®„Åó„Å¶Â§±Ê†º„Åß„Åô„ÄÇ`;

                if (diffConfig.isZeroSum) {
                    damageInstruction = `„ÄêÁâπÂà•„É´„Éº„É´Ôºö„ÉÄ„É°„Éº„Ç∏ÂàÜÈÖçÂà∂ (Á∑èÈáè ${diffConfig.totalDmg})„Äë‰∏äË®ò„ÅÆÊé°ÁÇπÂü∫Ê∫ñ„Å´Âü∫„Å•„Åç„ÄÅÁ∑è„ÉÄ„É°„Éº„Ç∏ ${diffConfig.totalDmg} „ÇíÂàÜÈÖç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ„É¶„Éº„Ç∂„ÉºËá™ÁàÜ=„É¶„Éº„Ç∂„ÉºÂÖ®„ÉÄ„É°„Éº„Ç∏„ÄÇS„É©„É≥„ÇØ=AIÂÖ®„ÉÄ„É°„Éº„Ç∏„ÄÇÂêàË®à„ÅåÂøÖ„Åö${diffConfig.totalDmg}„Å´„Å™„Çã„Çà„ÅÜ„Å´„ÄÇ`;
                } else {
                    damageInstruction = `„ÄêÈÄöÂ∏∏„ÉÄ„É°„Éº„Ç∏„É´„Éº„É´„Äë„É¶„Éº„Ç∂„ÉºÊîªÊíÉ‰∏äÈôê20„ÄÅAIÊîªÊíÉ‰∏äÈôê${diffConfig.maxDmg}„ÄÇ„É¶„Éº„Ç∂„ÉºËá™ÁàÜ„Å™„Çâuser_damageÊúÄÂ§ß„ÄÅai_damage0„ÄÇ`;
                }

                if (state.difficulty === 'easy') { replyLimit = "80ÊñáÂ≠ó‰ª•ÂÜÖ"; aiBehaviorInstruction = `**Èõ£ÊòìÂ∫¶: EASY**„ÄÇ80%„ÅÆÁ¢∫Áéá„ÅßË´ñÁêÜÁöÑ„Åß„Å™„ÅÑÂ≠ê‰æõ„Å£„ÅΩ„ÅÑÊÇ™Âè£„ÇÑÊÑèÂë≥‰∏çÊòé„Å™Áô∫Ë®Ä„Çí„Åó„ÄÅÈöô„ÇíË¶ã„Åõ„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇÂ∞ë„Åó„Å†„ÅëË™¨Âæó„Å´Á©¥„ÅÆ„ÅÇ„ÇãÊñáÁ´†„Å´„Åô„Çã„Åì„Å®„ÄÇ`; }
                else if (state.difficulty === 'normal') { replyLimit = "80ÊñáÂ≠ó‰ª•ÂÜÖ"; aiBehaviorInstruction = `**Èõ£ÊòìÂ∫¶: NORMAL**„ÄÇÂü∫Êú¨„ÅØË´ñÁêÜÁöÑ„Åß„Åô„Åå„ÄÅ30%Á®ãÂ∫¶„ÅßÊÑüÊÉÖÁöÑ„Å´„Å™„ÇäË´ñÁÇπ„Åå„Åö„Çå„Çã‰∫∫ÈñìÂë≥„ÇíË¶ã„Åõ„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`; }
                else if (state.difficulty === 'hard') { replyLimit = "150„Äú180ÊñáÂ≠ó"; aiBehaviorInstruction = `**Èõ£ÊòìÂ∫¶: HARD**„ÄÇÁÜüÁ∑¥„ÅÆ„Éá„Ç£„Éô„Éº„Çø„Éº„Å®„Åó„Å¶ÊåØ„ÇãËàû„Å£„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇË´ñÁêÜÁöÑ„Åã„Å§ÊîªÊíÉÁöÑ„Å´„ÄÅÁ¥Ñ150„Äú180ÊñáÂ≠ó„ÅÆË™¨ÂæóÂäõ„ÅÇ„ÇãÊñáÁ´†„ÅßÂèçË´ñ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`; }
                else { replyLimit = "Êé®Êï≤„Åó200ÊñáÂ≠ó‰ª•ÂÜÖ"; aiBehaviorInstruction = `**Èõ£ÊòìÂ∫¶: KING**„ÄÇ‰∏ñÁïåÊúÄÂº∑„ÅÆË´ñÂÆ¢„Å®„Åó„Å¶„ÄÅÂÜ∑Âæπ„Åã„Å§ÂÆåÁíß„Å™Ë´ñÁêÜ„ÅßÁõ∏Êâã„Çí„Å≠„Åò‰ºè„Åõ„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ200ÊñáÂ≠ó‰ª•ÂÜÖ„ÅÆÂáùÁ∏Æ„Åï„Çå„ÅüË´ñÁêÜ„ÅßÂÆåÂÖ®Ë´ñÁ†¥„ÇíË°å„Å£„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ„ÇÇ„ÅóÂà§ÂÆö„ÅßAI„ÅåË≤†„Åë„ÅüÔºàai_damage„ÅåÂ§ß„Åç„ÅÑÔºâÂ†¥Âêà„ÅØ„ÄÅ„Éó„É©„Ç§„Éâ„ÅåÂ¥©„Çå„Åï„ÇäÂãïÊè∫„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`; }

                const systemPrompt = `„ÅÇ„Å™„Åü„ÅØ„Äå${state.enemyFaction === 'takenoko' ? '„Åü„Åë„ÅÆ„Åì„ÅÆÈáå' : '„Åç„ÅÆ„Åì„ÅÆÂ±±'}Ê¥æ„Äç„ÅÆ„Äå${enemyData.name}„Äç„Åß„Åô„ÄÇ${judgeCriteria} ${damageInstruction} ${aiBehaviorInstruction} ‰ª•‰∏ã„ÅÆJSON„Éï„Ç©„Éº„Éû„ÉÉ„Éà„ÅßÂøúÁ≠î: { "reply": "„É¶„Éº„Ç∂„Éº„Å∏„ÅÆÂèçË´ñÔºà${replyLimit}Ôºâ", "user_damage": Êï¥Êï∞, "is_block": boolean, "ai_damage": Êï¥Êï∞, "is_critical": boolean, "shout": "Ë´ñÁ†¥ÔºÅ"„Å™„Å©„ÅÆÂè´„Å≥ } „Ç≠„É£„É©Ë®≠ÂÆö: ${enemyData.text}`;
                
                debugSystem.log("SYSTEM PROMPT", systemPrompt);

                //„É™„Éà„É©„Ç§Ê©üËÉΩÔºÅÔºÅÔºÅ(Gemini API„Ç®„É©„ÉºÂá∫„Åó„Åô„Åé„Å¶„ÄÅ„Åì„Çå„Å™„ÅÑ„Å®„Ç®„É©„Éº„Å∞„Å£„Åã„ÇäÂá∫„Åô)
                let retryCount = 0;
                const maxRetries = 2; // ÂàùÂõû + ÂÜçË©¶Ë°å2Âõû = Ë®à3Âõû
                let responseJson = null;

                while (retryCount <= maxRetries) {
                    try {
                        const res = await fetch('/api/chat', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ 
                                history: state.history,
                                systemInstruction: systemPrompt,
                                message: isFirstStrike ? firstStrikeMsg : userLastText,
                                responseMimeType: "application/json"
                            })
                        });
                        
                        if (!res.ok) {
                            // „Çµ„Éº„Éê„Éº„Ç®„É©„Éº503!!!!!!!!!!!!!!!!!!!!!!?
                            throw new Error(`Server Error: ${res.status}`);
                        }
                        
                        // ÊàêÂäü„Åó„Åü„Çâ„É´„Éº„Éó„ÇíÊäú„Åë„Çã
                        responseJson = await res.json();
                        break; 

                    } catch (e) {
                        //„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„ÅüÂ†¥Âêà
                        if (retryCount < maxRetries) {
                           
                            retryCount++;
                            const waitTime = 5000; 
                            debugSystem.log("RETRY", `„Çµ„Éº„Éê„ÉºÊ∑∑Èõë(503)„ÅÆ„Åü„ÇÅÂæÖÊ©ü‰∏≠... ${waitTime/1000}ÁßíÂæå„Å´ÂÜçË©¶Ë°å„Åó„Åæ„Åô (${retryCount}/${maxRetries})`);
                            
                            // 5ÁßíÂæÖÊ©üÔºÅÔºÅ„Åì„Çå„ÇÅ„Å°„ÇÉ„Åè„Å°„ÇÉÈáçË¶Å
                            await wait(waitTime);
                        } else {
                            // ‰ªè„ÅÆÈ°î„ÇÇ‰∏âÂ∫¶„Åæ„Åß
                            throw e; 
                        }
                    }
                }
                

                const responseText = responseJson.text;
                debugSystem.log("AI RESPONSE", responseText);
                const data = JSON.parse(responseText);
                removeLoading(loadingId);

                // „ÉÄ„É°„Éº„Ç∏Ë®àÁÆó
                let userDmg = data.user_damage || 0; let aiDmg = data.ai_damage || 0;
                if (diffConfig.isZeroSum && !isFirstStrike) {
                    const total = userDmg + aiDmg;
                    if (total === 0) { userDmg = diffConfig.totalDmg; aiDmg = 0; } 
                    else { const ratio = userDmg / total; userDmg = Math.round(diffConfig.totalDmg * ratio); aiDmg = diffConfig.totalDmg - userDmg; }
                } else if (!diffConfig.isZeroSum && !isFirstStrike) {
                    userDmg = Math.min(20, userDmg); aiDmg = Math.min(diffConfig.maxDmg, aiDmg);
                }
                if (isFirstStrike) userDmg = 0;

                // „ÉÄ„É°„Éº„Ç∏Ë®àÁÆó„ÅÆËøΩÂä†„É´„Éº„É´
                if (!isFirstStrike) {
                    if (data.is_block && !diffConfig.isZeroSum) { showFloatingText('hp-bar-enemy', "BLOCK!", "block-text"); AudioSys.se.block(); }
                    else if (aiDmg > 0) { state.enemyHP = Math.max(0, state.enemyHP - aiDmg); showFloatingDamage('hp-bar-enemy', aiDmg); AudioSys.se.damage(); shakeScreen('small'); updateHPUI(); }
                }
                if (state.enemyHP <= 0) { finishGame(true); return; }

              
                await wait(600);
                if (data.is_critical || (diffConfig.isZeroSum && aiDmg >= diffConfig.totalDmg * 0.8)) { AudioSys.se.critical(); showCutIn(data.shout || "Ë´ñÁ†¥ÔºÅ"); await wait(1000); }
                addMessage(data.reply, 'opponent', enemyData.name);
                
                
                if (isFirstStrike) {
                    state.history.push({ role: "user", parts: [{ text: firstStrikeMsg }] });
                }
                state.history.push({ role: "model", parts: [{ text: data.reply }] });

                // „É¶„Éº„Ç∂„Éº„ÉÄ„É°„Éº„Ç∏Âá¶ÁêÜ
                if (userDmg > 0) {
                    await wait(600); state.playerHP = Math.max(0, state.playerHP - userDmg);
                    document.getElementById('flash-overlay').classList.add('flash-damage'); setTimeout(() => document.getElementById('flash-overlay').classList.remove('flash-damage'), 300);
                    showFloatingDamage('hp-bar-player', userDmg);
                    if (userDmg >= 20) { shakeScreen('hard'); AudioSys.se.damage(); } else { shakeScreen('small'); AudioSys.se.damage(); }
                    updateHPUI();
                    if (diffConfig.isZeroSum && !isFirstStrike) {
                        if (userDmg === 0 && aiDmg === diffConfig.totalDmg) showPerfect("PERFECT!!");
                        else if (aiDmg === 0 && userDmg === diffConfig.totalDmg) showPerfect("PERFECT!!"); 
                    }
                } else if (diffConfig.isZeroSum && !isFirstStrike && aiDmg === diffConfig.totalDmg) { showPerfect("PERFECT!!"); }

                if (state.playerHP <= 0) { finishGame(false); }

            } catch (e) {
                // „É™„Éà„É©„Ç§„ÇÇÂÖ®„Å¶Â§±Êïó„Åó„ÅüÊôÇ
                console.error(e); 
                removeLoading(loadingId); 
                addMessage("(„Ç∑„Çπ„ÉÜ„É†„Ç®„É©„Éº: „Çµ„Éº„Éê„Éº„ÅåÊ∑∑„ÅøÂêà„Å£„Å¶„ÅÑ„Åæ„Åô„ÄÇÊôÇÈñì„ÇíÁΩÆ„ÅÑ„Å¶ÂÜçË™≠Ëæº„Åó„Å¶„Åè„Å†„Åï„ÅÑüçÑ)", 'opponent'); 
                debugSystem.log("ERROR", e.toString());
            } finally {
                state.isProcessing = false;
                if (!state.isGameFinished && state.playerHP > 0 && state.enemyHP > 0) { btn.disabled = false; input.disabled = false; input.placeholder = "Ë®ÄËëâ„ÅÆÊ≠¶Âô®„ÅßÊîªÊíÉ„Åõ„Çà..."; input.focus(); }
            }
        }

        //HP UIÊõ¥Êñ∞
        window.updateHPUI = () => {
            const pPct = (state.playerHP / state.maxPlayerHP) * 100; const ePct = (state.enemyHP / state.maxEnemyHP) * 100;
            document.getElementById('hp-bar-player').style.width = `${pPct}%`; document.getElementById('hp-bar-enemy').style.width = `${ePct}%`;
            document.getElementById('hp-bar-player').style.backgroundColor = getHPColor(pPct); document.getElementById('hp-bar-enemy').style.backgroundColor = getHPColor(ePct);
            document.getElementById('hp-val-player').innerText = `${state.playerHP}`; document.getElementById('hp-val-enemy').innerText = `${state.enemyHP}`;
        }
        function getHPColor(pct) { if (pct > 50) return 'var(--hp-high)'; if (pct > 20) return 'var(--hp-mid)'; return 'var(--hp-low)'; }
        function showFloatingDamage(targetId, amount) { showFloatingText(targetId, `-${amount}`, "damage-number"); }
        function showFloatingText(targetId, text, className) {
            const target = document.getElementById(targetId); const rect = target.getBoundingClientRect(); const el = document.createElement('div');
            el.className = className + " absolute z-50 font-black"; el.innerText = text; if(!el.classList.contains('damage-number')) el.style.animation = "float-up 1s forwards";
            const offset = Math.random() * 40 - 20; el.style.left = (rect.left + rect.width / 2 + offset) + 'px'; el.style.top = (rect.top + 20) + 'px';
            document.body.appendChild(el); setTimeout(() => el.remove(), 1000);
        }
        function showCutIn(text) {
            const el = document.getElementById('cut-in'); const txt = document.getElementById('cut-in-text'); document.getElementById('perfect-text').style.opacity = '0';
            txt.innerText = text; el.classList.add('active'); setTimeout(() => el.classList.remove('active'), 1200);
        }
        function showPerfect(text) {
             const el = document.getElementById('cut-in'); const pTxt = document.getElementById('perfect-text'); pTxt.innerText = text;
             document.getElementById('cut-in-text').innerText = ""; el.classList.add('active'); el.classList.add('perfect-active'); AudioSys.se.perfect();
             setTimeout(() => { el.classList.remove('active'); el.classList.remove('perfect-active'); }, 1500);
        }
        function shakeScreen(type) { const body = document.body; body.classList.remove('shake-small', 'shake-hard'); void body.offsetWidth; body.classList.add(type === 'hard' ? 'shake-hard' : 'shake-small'); }
        function addMessage(text, type, name = "YOU") {
            const container = document.getElementById('battle-area'); const div = document.createElement('div');
            div.className = `chat-bubble ${type}`; div.innerHTML = `<div class="text-xs font-bold opacity-70 mb-1">${name}</div><div>${text.replace(/\n/g, '<br>')}</div>`;
            container.appendChild(div); container.scrollTop = container.scrollHeight;
        }
        function addLoading() {
            const container = document.getElementById('battle-area'); const id = 'loading-' + Date.now(); const div = document.createElement('div'); div.id = id;
            div.className = `chat-bubble opponent opacity-70`; div.innerHTML = `<div class="flex gap-1 items-center h-6"><div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div><div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay:0.1s"></div><div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay:0.2s"></div></div>`;
            container.appendChild(div); container.scrollTop = container.scrollHeight; return id;
        }
        function removeLoading(id) { const el = document.getElementById(id); if (el) el.remove(); }
        function wait(ms) { return new Promise(resolve => setTimeout(resolve, ms)); }

        //„Ç≤„Éº„É†ÁµÇ‰∫ÜÂá¶ÁêÜ„É™„Ç∂„É´„ÉàÁîªÈù¢„Å®„Åã
        window.finishGame = async (isPlayerWin) => {
            if (state.isGameFinished) return;
            state.isGameFinished = true;
            document.body.classList.remove('battle-mode'); 
            AudioSys.playBGM(isPlayerWin ? 'win' : 'lose');
            AudioSys.se.ko();
            
            const overlay = document.getElementById('ko-overlay');
            const simpleView = document.getElementById('result-simple');
            const detailView = document.getElementById('result-detail');
            const loadingView = document.getElementById('result-loading');
            const announce = document.getElementById('winner-announce');
            const showResultBtn = document.getElementById('btn-show-result');

            simpleView.classList.remove('hidden'); simpleView.classList.add('flex');
            detailView.classList.add('hidden'); detailView.classList.remove('flex');
            loadingView.classList.add('hidden'); loadingView.classList.remove('flex');
            
            announce.innerText = isPlayerWin ? "YOU WIN! ÂÆåÂÖ®Ë´ñÁ†¥" : "YOU LOSE... ÊïóÂåó";
            announce.className = isPlayerWin ? "text-4xl font-black text-green-400 mb-8 animate-pulse drop-shadow-[0_0_10px_rgba(74,222,128,0.8)]" : "text-4xl font-black text-blue-400 mb-8 drop-shadow-[0_0_10px_rgba(96,165,250,0.8)]";
            overlay.classList.remove('hidden'); overlay.classList.add('flex');

            showResultBtn.classList.add('hidden');
            try {
                showResultBtn.onclick = () => generateResult(isPlayerWin);
                showResultBtn.classList.remove('hidden');
            } catch(e) { console.error("Setup Result Error", e); }
        }

        window.showDetailResult = () => generateResult(state.playerHP > 0);

        async function generateResult(isPlayerWin) {
            const simpleView = document.getElementById('result-simple');
            const loadingView = document.getElementById('result-loading');
            const detailView = document.getElementById('result-detail');
            
            simpleView.classList.add('hidden'); simpleView.classList.remove('flex');
            loadingView.classList.remove('hidden'); loadingView.classList.add('flex');

            try {
                const enemyData = personas[state.enemyFaction].find(p => p.id === state.enemyId);
                const historyText = state.history.map(h => `[${h.role}]: ${h.parts[0].text}`).join("\n");
                //„É™„Ç∂„É´„Éà„ÅÆ„Éó„É≠„É≥„Éó„ÉàÁîüÊàê
                const prompt = `
                „ÅÇ„Å™„Åü„ÅØ„Äå„Åç„ÅÆ„Åì„Åü„Åë„ÅÆ„ÅìË´ñ‰∫â„Äç„ÅÆ8bit„Ç≤„Éº„É†„ÅÆÂØ©Âà§„Åß„Åô„ÄÇ‰ª•‰∏ã„ÅÆÊà¶„ÅÑ„ÅÆË®òÈå≤„ÇíÂàÜÊûê„Åó„ÄÅJSONÂΩ¢Âºè„Åß„É™„Ç∂„É´„Éà„ÇíÂá∫Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
                „É¶„Éº„Ç∂„Éº„ÅØ„Äå${state.playerFaction}Ê¥æ„Äç„ÄÅÂØæÊà¶Áõ∏Êâã„ÅØ„Äå${enemyData.name}Ôºà${state.enemyFaction}Ê¥æÔºâ„Äç„Åß„Åô„ÄÇ
                ÂãùÊïó: ${isPlayerWin ? "„É¶„Éº„Ç∂„Éº„ÅÆÂãùÂà©" : "„É¶„Éº„Ç∂„Éº„ÅÆÊïóÂåó"}

                „ÄêÊà¶„ÅÑ„ÅÆË®òÈå≤„Äë
                ${historyText}

                „ÄêÂá∫Âäõ„Éï„Ç©„Éº„Éû„ÉÉ„ÉàÔºàJSONÔºâ„Äë
                {
                  "score": 0„Äú100„ÅÆÊï¥Êï∞ÔºàË´ñÁ†¥Â∫¶„ÄÇÂãù„Å£„Å¶„ÅÑ„Çå„Å∞80‰ª•‰∏ä„ÄÅË≤†„Åë„Å¶„ÅÑ„Çå„Å∞‰Ωé„ÅÑÔºâ,
                  "rank": "S" / "A" / "B" / "C" („Çπ„Ç≥„Ç¢„Å´Âøú„Åò„Åü„É©„É≥„ÇØ),
                  "title": "Ôºà‰æãÔºöÊÉÖÁÜ±„ÅÆÂºÅË´ñÂÆ∂„ÄÅÂÜ∑Âæπ„Å™Ë´ñÁêÜ„Éû„Ç∑„Éº„É≥„ÄÅ„Å™„Å©„É¶„Éº„Ç∂„Éº„Å∏„ÅÆÁü≠„ÅÑÁß∞Âè∑Ôºâ",
                  "summary": "Êà¶„ÅÑ„ÅÆÁ∑èË©ïÔºà100ÊñáÂ≠óÁ®ãÂ∫¶Ôºâ„ÄÇ„É¶„Éº„Ç∂„Éº„ÅÆË´ñÁêÜÂ±ïÈñã„ÇÑÁÖΩ„Çä„ÅÆÂÇæÂêë„Å´„Å§„ÅÑ„Å¶„ÄÇ",
                  "good_point": "ÂÖ∑‰ΩìÁöÑ„Å´„Å©„ÅÆÁô∫Ë®Ä„ÅåÂäπÊûúÁöÑ„Å†„Å£„Åü„ÅãÔºà„Å™„Åë„Çå„Å∞„ÄåÁâπ„Å´„Å™„Åó„ÄçÔºâ„ÄÇ",
                  "enemy_comment": "ÂØæÊà¶Áõ∏ÊâãÔºà${enemyData.name}Ôºâ„Åã„Çâ„ÅÆ‰∫ãÂæå„Ç≥„É°„É≥„Éà„ÄÇÊÄßÊ†ºÔºà${enemyData.text}Ôºâ„ÇíÂèçÊò†„Åï„Åõ„ÄÅÂãù„Å£„Å¶„ÅÑ„Çå„Å∞ÊÇî„Åó„Åå„Çä„ÄÅË≤†„Åë„Å¶„ÅÑ„Çå„Å∞Âãù„Å°Ë™á„Çã„ÄÇ"
                }
                `;

                const res = await fetch('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        prompt: prompt,
                        responseMimeType: "application/json"
                    })
                });
                //Êú™Ëß£Ê±∫ÔºÅÔºÅ„Åü„Åæ„Å´„Åì„Åì„Åß„Ç®„É©„Éº„Å´„Å™„Çã
                if (!res.ok) throw new Error("Result API Error");
                
                const responseJson = await res.json();
                const jsonText = responseJson.text;
                const data = JSON.parse(jsonText);

                document.getElementById('res-score').innerText = data.score + "%";
                document.getElementById('res-rank').innerText = data.rank;
                document.getElementById('res-title').innerText = "Áß∞Âè∑: " + data.title;
                document.getElementById('res-summary').innerText = data.summary;
                document.getElementById('res-good').innerText = data.good_point;
                document.getElementById('res-enemy-msg').innerText = data.enemy_comment;
                
                const rankEl = document.getElementById('res-rank');
                if(data.rank === 'S') rankEl.className = 'res-rank text-yellow-400 text-6xl font-black drop-shadow-[0_0_10px_gold]';
                else if(data.rank === 'A') rankEl.className = 'res-rank text-red-400 text-5xl font-bold';
                else rankEl.className = 'res-rank text-blue-400 text-4xl';

                loadingView.classList.add('hidden'); loadingView.classList.remove('flex');
                detailView.classList.remove('hidden'); detailView.classList.add('flex');

            } catch (e) {
                console.error("Result Gen Error", e);
                alert("„É™„Ç∂„É´„ÉàÁîüÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ(API Error)");
                loadingView.classList.add('hidden');
                simpleView.classList.remove('hidden');
            }
        }
    
    
    </script>
    <!-- „Åì„Åì„Åã„ÇâReact„ÅÆÊäïÁ•®„ÇÆ„Éü„ÉÉ„ÇØ-->
    <script type="text/babel">
        const { useState, useEffect } = React;

        const VoteComponent = () => {
            const [votes, setVotes] = useState({ kinoko: 0, takenoko: 0 });
            const [hasVoted, setHasVoted] = useState(false);
            const [battleId, setBattleId] = useState(null);
            const [isLoading, setIsLoading] = useState(false);

            //Êñ∞„Åó„ÅÑ„Éê„Éà„É´„Å™„ÇâÊäïÁ•®Ê®©Âæ©Ê¥ª
            useEffect(() => {
                const checkBattle = () => {
                    
                    if (window.currentBattleId !== battleId) {
                        setBattleId(window.currentBattleId);
                        setHasVoted(false);
                        fetchVotes();
                    }
                };
                
                // „É™„Ç∂„É´„Éà„ÅåË°®Á§∫„Åï„Çå„Çã„Åü„Å≥„Å´„ÉÅ„Çß„ÉÉ„ÇØ
                const interval = setInterval(checkBattle, 1000);
                checkBattle(); // ÂàùÂõûÂÆüË°å

                return () => clearInterval(interval);
            }, [battleId]);

            const fetchVotes = async () => {
                try {
                    const res = await fetch('/api/votes');
                    const data = await res.json();
                    setVotes(data);
                } catch (e) {
                    console.error("Failed to fetch votes", e);
                }
            };

            const handleVote = async (faction) => {
                if (hasVoted || isLoading) return;
                setIsLoading(true);

                try {
                    const res = await fetch('/api/votes', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ faction })
                    });
                    const data = await res.json();
                    setVotes(data);
                    setHasVoted(true);
                } catch (e) {
                    console.error("Vote failed", e);
                } finally {
                    setIsLoading(false);
                }
            };

            const total = votes.kinoko + votes.takenoko;
            const kinokoPct = total === 0 ? 50 : Math.round((votes.kinoko / total) * 100);
            const takenokoPct = total === 0 ? 50 : Math.round((votes.takenoko / total) * 100);

            return (
                <div className="border-4 border-white bg-gray-800 p-4 font-mono text-white">
                    <h3 className="text-center text-yellow-400 font-bold mb-2 border-b-2 border-gray-600 pb-1">
                        FACTION WAR VOTING
                    </h3>
                    
                    {/* „Ç∞„É©„ÉïÈÉ®ÂàÜ */}
                    <div className="flex items-center justify-between text-xs mb-1 px-1">
                        <span className="text-orange-400">üçÑ {votes.kinoko}</span>
                        <span className="text-gray-400">TOTAL: {total}</span>
                        <span className="text-green-400">üéç {votes.takenoko}</span>
                    </div>
                    <div className="h-4 w-full flex border-2 border-white mb-4">
                        <div 
                            style={{ width: `${kinokoPct}%` }} 
                            className="bg-orange-600 h-full transition-all duration-500"
                        />
                        <div 
                            style={{ width: `${takenokoPct}%` }} 
                            className="bg-green-600 h-full transition-all duration-500"
                        />
                    </div>

                    {/* ÊäïÁ•®„Éú„Çø„É≥ */}
                    {!hasVoted ? (
                        <div className="grid grid-cols-2 gap-4">
                            <button 
                                onClick={() => handleVote('kinoko')}
                                disabled={isLoading}
                                className="bg-orange-800 border-2 border-orange-500 hover:bg-orange-700 active:translate-y-1 p-2 text-sm font-bold transition-none"
                            >
                                VOTE<br/>KINOKO
                            </button>
                            <button 
                                onClick={() => handleVote('takenoko')}
                                disabled={isLoading}
                                className="bg-green-800 border-2 border-green-500 hover:bg-green-700 active:translate-y-1 p-2 text-sm font-bold transition-none"
                            >
                                VOTE<br/>TAKENOKO
                            </button>
                        </div>
                    ) : (
                        <div className="text-center bg-gray-700 py-2 border-2 border-gray-500 text-yellow-200 animate-pulse">
                            VOTE ACCEPTED!
                        </div>
                    )}
                    <div className="text-[10px] text-center text-gray-500 mt-2">
                        ‚Äª 1„Éê„Éà„É´„Å´„Å§„Åç1Âõû„ÅÆ„ÅøÊäïÁ•®ÂèØËÉΩ
                    </div>
                </div>
            );
        };

        // React„ÅÆ„Éû„Ç¶„É≥„Éà
        const rootElement = document.getElementById('react-vote-root');
        if (rootElement) {
            const root = ReactDOM.createRoot(rootElement);
            root.render(<VoteComponent />);
        }

        // „Éê„Éà„É´ÈñãÂßãÊôÇ„Å´ID„ÇíÁîüÊàê„Åó„ÄÅÊäïÁ•®Ê®©„Çí„É™„Çª„ÉÉ„Éà„Åô„Çã„Åü„ÇÅ„ÅÆ„Éà„É™„Ç¨„Éº„Å®„Åô„Çã
        const originalStartSequence = window.startSequence;
        window.startSequence = () => {
            window.currentBattleId = Date.now(); // IDÊõ¥Êñ∞
            if (originalStartSequence) originalStartSequence();
        };

        // ÂàùÂõû„É≠„Éº„ÉâÁî®„ÅÆID
        window.currentBattleId = Date.now();
    </script>
</body>
</html>